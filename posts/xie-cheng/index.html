<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>协程 | sanhuzhen&#x27;s blog</title>

  
  

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400..700&family=Noto+Serif+SC:wght@200..900&family=STIX+Two+Text:ital,wght@0,400..700;1,400..700&family=Ysabeau:ital,wght@0,1..1000;1,1..1000&display=swap" rel="stylesheet">
  <link rel='stylesheet' href='https://chinese-fonts-cdn.deno.dev/packages/lxgwwenkaibright/dist/LXGWBright-Regular/result.css' />
  <link rel='stylesheet' href='https://chinese-fonts-cdn.deno.dev/packages/syst/dist/SourceHanSerifCN/result.css' />
  <link rel='stylesheet' href='https://unpkg.com/ress/dist/ress.min.css'>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jQuery.mmenu/8.5.10/mmenu.min.css">
  <link rel="stylesheet" href="https://blog.sanhuzhen.top/style.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" rel="stylesheet">

  
  <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
        processEscapes: true,
        processEnvironments: true
      },
      options: {
        skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
      }
    };
  </script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@4/tex-svg.js"></script>
  <script>
      document.addEventListener("DOMContentLoaded", function() {
          // Unwrap code blocks for MathJax
          // 1. Display Math (```math-display ... ```)
          document.querySelectorAll('code.language-math-display').forEach(el => {
              const pre = el.parentElement;
              if (pre.tagName === 'PRE') {
                  const math = el.textContent.trim();
                  const div = document.createElement('div');
                  div.textContent = math;
                  pre.replaceWith(div);
              }
          });

          // 2. Inline Math (`$ ... $`)
          document.querySelectorAll('code').forEach(el => {
              if (el.classList.contains('language-math-display')) return;
              if (el.parentElement.tagName === 'PRE') return;

              const text = el.textContent.trim();
              // Check if it looks like math: $...$
              if (text.startsWith('$') && text.endsWith('$') && !text.startsWith('$$')) {
                  const span = document.createElement('span');
                  span.textContent = text;
                  el.replaceWith(span);
              }
          });
          
          // Trigger MathJax to process the new elements
          if (typeof MathJax !== 'undefined' && MathJax.typesetPromise) {
              MathJax.typesetPromise();
          }
      });
  </script>
  

  
<!-- Primary Meta Tags -->
 
<meta
  name="description"
  content="协程相关"
/>

<!-- Open Graph / Facebook -->
<meta property="og:title" content="协程 | sanhuzhen&#x27;s blog" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.sanhuzhen.top/posts/xie-cheng/" />

<meta property="article:published_time" content="2026-02-03" />
<meta property="article:modified_time" content="2026-02-03" />

<meta property="article:section" content="posts" />
<!--
  
    
      
        <meta property="article:tag" content="Android">
      
        <meta property="article:tag" content="Kotlin">
      
        <meta property="article:tag" content="协程">
      
    
  
-->


</head>

<body class="body-block">
  <div id="sidebar-mask" onclick="toggleSidebar()"></div>
  
  <div id="sidebar" class="">
    <div class="logo-title">
      <div class="title-inner">
        
        <div class="avatar">
          <img src="https://blog.sanhuzhen.top/images/logo.png" alt="avatar">
        </div>
        
        <div class="title">
          <h3><a href="https://blog.sanhuzhen.top/">sanhuzhen&#x27;s blog</a></h3>
          <div class="description">
            <p>sanhuzhen&#x27;s blog</p>
          </div>
        </div>
      </div>
      <ul class="social-links">
        
        <li>
          <a href="https://github.com/sanhuzhen" aria-label="Github">
            <i class="fab fa-github"></i>
          </a>
        </li>
        
        <li>
          <a href="sanhuzhen@foxmail.com" aria-label="Email">
            <i class="fas fa-envelope"></i>
          </a>
        </li>
        
        <li>
          <a href="/atom.xml" aria-label="Rss">
            <i class="fas fa-rss"></i>
          </a>
        </li>
        
      </ul>
      <div class="sidebar-action">
        <a href="https://blog.sanhuzhen.top/about/">About Me</a>
      </div>
      <nav class="sidebar-nav">
        <a href="https://blog.sanhuzhen.top/">Home</a>
        <a href="https://blog.sanhuzhen.top/posts/">Posts</a>
        <a href="https://blog.sanhuzhen.top/archive/">Archives</a>
        <a href="https://blog.sanhuzhen.top/tags/">Categories</a>
        <a href="https://blog.sanhuzhen.top/links/">Links</a>
      </nav>
    </div>
  </div>
  

  <div id="main">
    
    <div class="page-top animated fadeInDown">
      <nav class="nav">
        <a href="https://blog.sanhuzhen.top/">Home</a>
        <a href="https://blog.sanhuzhen.top/posts/" class="active">Posts</a>
        <a href="https://blog.sanhuzhen.top/about/" >About</a>
        <a href="https://blog.sanhuzhen.top/archive/" >Archives</a>
        <a href="https://blog.sanhuzhen.top/tags/" >Categories</a>
        <a href="https://blog.sanhuzhen.top/links/" >Links</a>
      </nav>
      <div class="information">
        <div class="back_btn">
          <a onclick="window.history.go(-1)" aria-label="Go back"><i class="fas fa-chevron-left"></i></a>
        </div>
        <div class="theme_btn">
          <a onclick="toggleTheme()" aria-label="Toggle theme"><i class="fas fa-moon" id="theme-icon"></i></a>
        </div>
        <div class="feed_btn">
          <a class="feed-icon" aria-label="RSS Feed"><i class="fas fa-rss"></i></a>
          <div class="feed-dropdown">
            <a href="https://blog.sanhuzhen.top/atom.xml" target="_blank">Atom</a>
            <a href="https://blog.sanhuzhen.top/rss.xml" target="_blank">RSS</a>
          </div>
        </div>
        <div class="avatar_btn">
          <a onclick="toggleSidebar()" aria-label="Toggle sidebar"><i class="fas fa-bars"></i></a>
        </div>
      </div>
    </div>
    
    <div class="autopagerize_page_element">
      <div class="content animated fadeIn ">
         

<article class="content-article">
  <main class="article-content">
    <div class="article-intro-container">
        <div class="intro-header">
            <h1 class="heading">协程</h1>
            <div class="meta-line">
                
                <span class="date">Feb. 03, 2026</span>
                
                
                
                <span class="separator">/</span>
                <span class="tags">
                
                <a href="https://blog.sanhuzhen.top/tags/android/">#Android</a>
                
                <a href="https://blog.sanhuzhen.top/tags/kotlin/">#Kotlin</a>
                
                <a href="https://blog.sanhuzhen.top/tags/xie-cheng/">#协程</a>
                
                </span>
                
            </div>
        </div>

        <div class="intro-body">
            
            <div class="intro-abstract">
                <div class="abstract-title">ABSTRACT</div>
                <p class="description">协程相关</p>
            </div>
            

            
            <details class="intro-toc">
                <summary class="toc-title">CONTENTS</summary>
                <div class="toc-wrapper">
                <ul class="toc-list">
                    <li class="toc-root">
                        <a href="#" class="active-toc">协程</a>
                        
                        <ul>
                            
                            <li>
                                <a href="https://blog.sanhuzhen.top/posts/xie-cheng/#zhuang-tai-ji-yuan-li">状态机原理</a>
                                
                            </li>
                            
                            <li>
                                <a href="https://blog.sanhuzhen.top/posts/xie-cheng/#gua-qi-han-shu">挂起函数</a>
                                
                                <ul>
                                    
                                    <li>
                                        <a href="https://blog.sanhuzhen.top/posts/xie-cheng/#delay">delay</a>
                                        
                                    </li>
                                    
                                    <li>
                                        <a href="https://blog.sanhuzhen.top/posts/xie-cheng/#withcontext">withContext</a>
                                        
                                    </li>
                                    
                                    <li>
                                        <a href="https://blog.sanhuzhen.top/posts/xie-cheng/#asynche-await">async和await</a>
                                        
                                    </li>
                                    
                                    <li>
                                        <a href="https://blog.sanhuzhen.top/posts/xie-cheng/#launch">launch</a>
                                        
                                    </li>
                                    
                                    <li>
                                        <a href="https://blog.sanhuzhen.top/posts/xie-cheng/#runblocking">runBlocking</a>
                                        
                                    </li>
                                    
                                </ul>
                                
                            </li>
                            
                            <li>
                                <a href="https://blog.sanhuzhen.top/posts/xie-cheng/#sheng-ming-zhou-qi">生命周期</a>
                                
                                <ul>
                                    
                                    <li>
                                        <a href="https://blog.sanhuzhen.top/posts/xie-cheng/#zhuang-tai-jian-ting">状态监听</a>
                                        
                                    </li>
                                    
                                </ul>
                                
                            </li>
                            
                            <li>
                                <a href="https://blog.sanhuzhen.top/posts/xie-cheng/#xie-cheng-zuo-yong-yu">协程作用域</a>
                                
                                <ul>
                                    
                                    <li>
                                        <a href="https://blog.sanhuzhen.top/posts/xie-cheng/#globalscope">GlobalScope</a>
                                        
                                    </li>
                                    
                                    <li>
                                        <a href="https://blog.sanhuzhen.top/posts/xie-cheng/#mainscope">MainScope</a>
                                        
                                    </li>
                                    
                                    <li>
                                        <a href="https://blog.sanhuzhen.top/posts/xie-cheng/#viewmodelscope">ViewModelScope</a>
                                        
                                    </li>
                                    
                                    <li>
                                        <a href="https://blog.sanhuzhen.top/posts/xie-cheng/#lifecyclescope">LifecycleScope</a>
                                        
                                    </li>
                                    
                                    <li>
                                        <a href="https://blog.sanhuzhen.top/posts/xie-cheng/#zi-ding-yi-scope">自定义Scope</a>
                                        
                                        <ul>
                                            
                                            <li>
                                                <a href="https://blog.sanhuzhen.top/posts/xie-cheng/#supervisorjob-vs-job">SupervisorJob vs Job</a>
                                            </li>
                                            
                                        </ul>
                                        
                                    </li>
                                    
                                </ul>
                                
                            </li>
                            
                        </ul>
                        
                    </li>
                </ul>
                </div>
            </details>
            
        </div>
    </div>
    
    <ol>
<li>轻量：占用内存少</li>
<li>减少回调：以同步的方式执行异步代码（会将函数挂起等待结果）</li>
</ol>
<h1 id="zhuang-tai-ji-yuan-li">状态机原理</h1>
<pre><code data-lang="Kotlin">suspend fun getData(): String {
    delay(1000)
    return &quot;hello coroutines&quot;
}
</code></pre>
<p>反编译</p>
<pre><code data-lang="Java">// suspend挂起函数，会主动在方法中添加Continuation类型参数
@Nullable
public final Object getData(@NotNull Continuation $completion) {
    Continuation $continuation;
    label20: {
        /**
​         * 如果传入的Continuation是&lt;undefinedtype&gt;类型，说明是第一次调用
​         * 如果不是，则说明是恢复调用，从$continuation中获取状态机的状态
​         */
​        ​if ($completion instanceof &lt;undefinedtype&gt;) {
            $continuation = (&lt;undefinedtype&gt;)$completion;
            if (($continuation.label &amp; Integer.MIN_VALUE) != 0) {
                $continuation.label -= Integer.MIN_VALUE;
                break label20;
            }
        }

        $continuation = new ContinuationImpl($completion) {
            // $FF: synthetic field
            Object result; // 存储中间结果
            int label; // 标签状态

            // 自己invoke方法，实现状态机恢复逻辑
            @Nullable
            public final Object invokeSuspend(@NotNull Object $result) {
                this.result = $result;
                this.label |= Integer.MIN_VALUE;
                return MainActivity.this.getData((Continuation)this);
            }
        };
    }
    
    // 开始执行逻辑
    Object $result = $continuation.result;
    Object var4 = IntrinsicsKt.getCOROUTINE_SUSPENDED();
    // 根据continuation的标签位，进行对应的操作
    switch ($continuation.label) {
        case 0:
            // 检查结果是否是异常，如果是则抛出
            ResultKt.throwOnFailure($result);
            // 设置下一个标签
            $continuation.label = 1;
            // 执行delay挂起操作，delay操作里面会执行continuation.resumeWith(Result.success(Unit))操作，这里会调用continuation的invokeSuspend方法
            if (DelayKt.delay(1000L, $continuation) == var4) {
                return var4;
            }
            break;
        case 1:
            // 继续检查，无误跳出switch，执行后续逻辑
            ResultKt.throwOnFailure($result);
            break;
        default:
            throw new IllegalStateException(&quot;call to &#39;resume&#39; before &#39;invoke&#39; with coroutine&quot;);
    }

    return &quot;hello coroutines&quot;;
}
</code></pre>
<p>上述操作被称为挂起函数的CSP操作</p>
<p><strong>协程依赖于底层</strong>​<strong>的状态机实现挂起和恢复，当遇到挂起点时，会去将当前协程挂起，并更新其内部的状态，将<code>continuation</code><strong>​</strong>的<code>label</code><strong>​</strong>标签设置为下一个要执行的</strong>​<strong>代码块编号，当要恢复的时候，协程内部会调用</strong>​**<code>continuation</code>的<strong>​</strong><code>resumWith</code>方法，去恢复协程运行，状态机根据保存的label值跳转到对应位置继续执行后续代码。**</p>
<h1 id="gua-qi-han-shu">挂起函数</h1>
<h2 id="delay">delay</h2>
<pre><code data-lang="Kotlin">delay(1000)
</code></pre>
<p>挂起1s</p>
<pre><code data-lang="Kotlin">public suspend fun delay(timeMillis: Long) {
    if (timeMillis &lt;= 0) return // don&#39;t delay
    return suspendCancellableCoroutine sc@ { ​cont: CancellableContinuation&lt;Unit&gt; -&gt;
​        ​// if timeMillis == Long.MAX_VALUE then just wait forever like awaitCancellation, don&#39;t schedule.
        if (timeMillis &lt; Long.MAX_VALUE) {
            cont.context.delay.scheduleResumeAfterDelay(timeMillis, cont)
        }
    }
}
</code></pre>
<h2 id="withcontext">withContext</h2>
<pre><code data-lang="Kotlin">withContext(Dispatchers.IO) {
​    ​
}
</code></pre>
<p>切换协程执行上下文（改变其运行的线程）</p>
<h2 id="asynche-await">async和await</h2>
<pre><code data-lang="Kotlin">val dataDeferred = GlobalScope.async {
    &quot;xxx&quot;
}
val data = dataDeferred .await()
</code></pre>
<p>开启并发协程并获取结果</p>
<h2 id="launch">launch</h2>
<pre><code data-lang="Kotlin">GlobalScope.launch ​{
​    ​
}
</code></pre>
<p>并不是传统的挂起函数，可以设置协程上下文，以及协程启动方式</p>
<blockquote>
<p>协程上下文</p>
<ol>
<li>Dispatchers.Main：Android专属，主线程，协程代码通过封装成Runnable执行</li>
<li>Dispatchers.IO：IO密集，网络请求，数据库操作，文件读取等IO操作</li>
<li>Dispatchers.Default：CPU密集，如大量计算，处理数据（注意：不能放到IO里面，会阻塞网络请求）</li>
<li>Dispatchers.Unconfined：纯挂起逻辑、无耗时的协程调度</li>
<li>Dispatchers.Main.immediate：Android专属，主线程内的挂起后立即执行逻辑</li>
</ol>
<p>注意：协程中唯一推荐的切换上下文的方法就是<code>withContext</code></p>
</blockquote>
<blockquote>
<p><strong>协程的启动方式</strong></p>
<ol>
<li><em>DEFAULT - 立即调度</em></li>
</ol>
<pre><code data-lang="Kotlin">launch(start = CoroutineStart.DEFAULT) {
    // 创建后立即进入调度队列
}
</code></pre>
<ol start="2">
<li><em>LAZY - 懒启动</em></li>
</ol>
<pre><code data-lang="Kotlin">val job = launch(start = CoroutineStart.LAZY) {
    // 需要手动启动
}
job.start()  // 启动协程，进入 ACTIVE 状态
</code></pre>
<ol start="3">
<li><em>ATOMIC - 原子启动（不可取消）</em></li>
</ol>
<pre><code data-lang="Kotlin">launch(start = CoroutineStart.ATOMIC) {
    // 启动后立即执行，不可取消
}
</code></pre>
<ol start="4">
<li><em>UNDISPATCHED - 立即在当前线程执行</em></li>
</ol>
<pre><code data-lang="Kotlin">launch(start = CoroutineStart.UNDISPATCHED) {
    // 立即在当前线程执行，直到第一个挂起点
}
</code></pre>
</blockquote>
<h2 id="runblocking">runBlocking</h2>
<pre><code data-lang="Kotlin">runBlocking ​{

}
</code></pre>
<p>阻塞线程的挂起函数</p>
<h1 id="sheng-ming-zhou-qi">生命周期</h1>
<pre><code data-lang="Plain">New (新建) → Active (活跃) → Completing (完成中) → Completed (已完成)
                ↓
            Cancelling (取消中) → Cancelled (已取消)
</code></pre>
<pre><code data-lang="JavaScript">suspend fun getData() {
    val job = CoroutineScope(Dispatchers.IO).launch(
        // 懒启动
        start = CoroutineStart.LAZY
​    ​) {
​        ​Log.d(TAG, &quot;getData() is running...&quot; + Thread.currentThread().name)
    }

​    ​// 来启动协程，此时其状态为NEW

    val job1 = CoroutineScope(Dispatchers.IO).launch​ ​{
​        ​// 处于ACTIVE状态
        Log.d(TAG, &quot;getData() is running...&quot; + Thread.currentThread().name)

        delay(1000) // 挂起点，仍然处于ACTIVE状态

        Log.d(TAG, &quot;getData() is running...&quot; + Thread.currentThread().name)

        // 如果没有异常和取消，进入 COMPLETING状态
    }

​    ​val job2 = CoroutineScope(Dispatchers.IO).launch​ ​{
​        ​try {
            repeat(100) { ​i -&gt;
​                ​Log.d(TAG, &quot;job: I am $i&quot;)
                delay(500)
            }
​        ​} finally {
            // 协程取消仍然会执行
            Log.d(TAG, &quot;job: I am running finally&quot;)

            withContext(NonCancellable) {
​                ​delay(1000)
            }
​        ​}
    }

​    ​delay(1300)
    job2.cancel() // 取消协程，进入 CANCELING 状态
    job2.join() // 等待协程结束，进入 CANCELLED 状态
}
</code></pre>
<h2 id="zhuang-tai-jian-ting">状态监听</h2>
<pre><code data-lang="Kotlin">val job = launch ​{
​    ​// 协程执行
}

// 1. 监听完成
job.invokeOnCompletion { ​cause -&gt;
​    ​println(&quot;协程完成，原因: $cause&quot;)
}

// 2. 检查状态
println(&quot;是否活跃: ${job.isActive}&quot;)
println(&quot;是否完成: ${job.isCompleted}&quot;)
println(&quot;是否取消: ${job.isCancelled}&quot;)

// 3. 等待完成
runBlocking ​{
​    ​job.join()  // 挂起直到协程完成
}
</code></pre>
<h1 id="xie-cheng-zuo-yong-yu">协程作用域</h1>
<pre><code data-lang="Kotlin">@Suppress(&quot;FunctionName&quot;)
public fun CoroutineScope(context: CoroutineContext): CoroutineScope =
    ContextScope(if (context[Job] != null) context else context + Job())
</code></pre>
<p>定义协程的生命周期以及执行的上下文</p>
<ol>
<li>生命周期管理：作用域取消时，内部所有协程自动取消</li>
<li>结构化并发：组织协程的父子关系</li>
<li>上下文传播：提供默认的调度器、异常处理器等</li>
</ol>
<h2 id="globalscope">GlobalScope</h2>
<p>生命周期与应用一样，尽量避免使用，容易造成内存泄漏</p>
<h2 id="mainscope">MainScope</h2>
<p>用于非Android环境的主线程作用域</p>
<pre><code data-lang="Kotlin">private val scope = MainScope()  // ​Dispatchers.Main + SupervisorJob()
</code></pre>
<h2 id="viewmodelscope">ViewModelScope</h2>
<p>适用于viewmodel的作用域</p>
<pre><code data-lang="Kotlin">implementation(&quot;androidx.lifecycle:lifecycle-viewmodel-ktx:2.8.0&quot;)
</code></pre>
<pre><code data-lang="Kotlin">viewModelScope.launch ​{
​    ​// 里面的内容会随着viewmodel被clear而取消
}

class MainViewModel: ViewModel() {
    val scope = CoroutineScope(Dispatchers.IO + SupervisorJob())
    
    // 如果要自定义的话，记得取消作用域
    override fun onCleared() {
        super.onCleared()
        scope.cancel()
    }
}
</code></pre>
<h2 id="lifecyclescope">LifecycleScope</h2>
<p>适用于activity的作用域</p>
<pre><code data-lang="Kotlin">implementation(&quot;androidx.lifecycle:lifecycle-runtime-ktx:2.8.0&quot;)
</code></pre>
<pre><code data-lang="Kotlin">lifecycleScope.launch ​{
​    ​// 里面的内容会随着activity被destory而取消
}

// 以下方法在生命周期离开对应状态时会挂起协程
lifecycleScope.launchWhenCreated { }   // CREATED状态
lifecycleScope.launchWhenStarted { }   // STARTED状态  ​
lifecycleScope.launchWhenResumed { }   // RESUMED状态
</code></pre>
<h2 id="zi-ding-yi-scope">自定义Scope</h2>
<pre><code data-lang="Kotlin">class MyCustomScope : CoroutineScope {
    private val job = SupervisorJob()

    override val coroutineContext: CoroutineContext
        get() = Dispatchers.Main + job + CoroutineName(&quot;MyScope&quot;)

    fun cleanup() {
        job.cancel()  // 取消所有子协程
    }
}
</code></pre>
<h3 id="supervisorjob-vs-job">SupervisorJob vs Job</h3>
<pre><code data-lang="Java">// 1. 使用 Job（默认）- 子协程异常会传播
val scope1 = CoroutineScope(Job() + Dispatchers.Main)
scope1.launch {
    launch ​{
​        ​throw Exception()  // 会取消父协程和其他子协程
    }
​    ​launch ​{
​        ​delay(1000)  // 这个不会执行，因为被异常取消了
    }
}

// 2. 使用 SupervisorJob - 子协程异常隔离
val scope2 = CoroutineScope(SupervisorJob() + Dispatchers.Main)
scope2.launch {
    launch ​{
​        ​throw Exception()  // 只影响自己
    }
​    ​launch ​{
​        ​delay(1000)  // 这个正常执行
        println(&quot;我还活着&quot;)
    }
}
</code></pre>


    <hr>

    <script src="https://giscus.app/client.js"
        data-repo="sanhuzhen/blog"
        data-repo-id="R_kgDOOIf2HA"
        data-category="Announcements"
        data-category-id="DIC_kwDOOIf2HM4C00ob"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="bottom"
        data-theme="light"
        data-lang="zh-CN"
        crossorigin="anonymous"
        async>
    </script>
  </main>
</article>

      </div>
    </div>
    <div class="page-footer">
      <div class="footer-content">
        <span>Based on theme <a href="https://github.com/Resorie/zola-theme-nivis">Nivis</a><span class="separator">/</span>Powered by <a href="https://www.getzola.org/" target="_blank">Zola</a></span>
      </div>
    </div>
  </div>

  <script>
    function toggleSidebar() {
      var sidebar = document.getElementById("sidebar");
      var mask = document.getElementById("sidebar-mask");
      sidebar.classList.toggle("open");
      mask.classList.toggle("open");
    }

    function toggleTheme() {
      const body = document.body;
      const icon = document.getElementById("theme-icon");
      if (body.getAttribute("data-theme") === "dark") {
        body.setAttribute("data-theme", "light");
        icon.classList.remove("fa-sun");
        icon.classList.add("fa-moon");
        localStorage.setItem("theme", "light");
      } else {
        body.setAttribute("data-theme", "dark");
        icon.classList.remove("fa-moon");
        icon.classList.add("fa-sun");
        localStorage.setItem("theme", "dark");
      }
    }

    // Initialize theme
    (function() {
      const savedTheme = localStorage.getItem("theme");
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      
      if (savedTheme === "dark" || (!savedTheme && prefersDark)) {
        document.body.setAttribute("data-theme", "dark");
        // Icon update will happen after DOM load if we put this script at the end, 
        // but since this is inline at the end of body, we might need to wait for DOMContentLoaded if the icon isn't ready?
        // Actually, this script is at the end of body, so elements should be parsed.
        const icon = document.getElementById("theme-icon");
        if (icon) {
            icon.classList.remove("fa-moon");
            icon.classList.add("fa-sun");
        }
      }
    })();

    // Footnote Navigation
    document.addEventListener("DOMContentLoaded", function() {
        // Code Block Language Label
        document.querySelectorAll('pre code').forEach(code => {
            const pre = code.parentElement;
            if (!pre.hasAttribute('data-lang')) {
                const classes = code.className.split(' ');
                for (const cls of classes) {
                    if (cls.startsWith('language-')) {
                        pre.setAttribute('data-lang', cls.replace('language-', ''));
                        break;
                    }
                }
            }
        });
    });
  </script>

  <script src="//instant.page/5.1.0" type="module" integrity="sha384-by67kQnR+pyfy8yWP4kPO12fHKRLHZPfEsiSXR8u2IKcTdxD805MGUXBzVPnkLHw"></script>
</body>

</html>
